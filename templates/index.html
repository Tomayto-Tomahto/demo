<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">		
		<title>Tomayto Tomahto</title>
		<!--Import Google Icon Font-->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<!--Import materialize.css-->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	</head>
	<style>
		html 
		{
			zoom:120%;
		}
		

	</style>
	<body>
	<div class="container">
		<div class="row">
			<div class="col s12 center-align valign-wrapper" id=wordandcontrols>
				<h1 id=word>{{ word }}</h1>
					<a class="btn-floating waves-effect waves-light red tooltipped"
					data-position="top" data-tooltip="skip" href = "{{url_for("skip")}}">
					<i id='skip' class="material-icons">chevron_right</i></a>
				<a href=# id="prediction" style="display:none;color:black;text-decoration:none"></a>
				<a href=# id="alert" onclick="M.toast({html: 'Not even close!'})" style="display:none;color:black;text-decoration:none"></a>
				<a id='mictooltip' class="btn-floating red tooltipped" data-position="right" data-tooltip="speak!">
					<i id='record' class="material-icons">mic</i>
				</a>
			</div>
			<div id="cards" style="display:none">
				<div id='card' class="col s5 card">
					<div class="card-content">
						<div class="col s2"><h2 id=result style="line-height:0%;font-weight:bold;"></h2><br></div>
						<div class="col s1"><h2 style="line-height:0%;font-weight:900;color:rgba(0,0,0,0.2);">%</h2></div>
						<div class="col s1">
							<h5 style="line-height:0%;font-weight:200;">native</h5>
							<h5 style="line-height:0%;font-weight:200;">speaker</h5>
						</div>
					</div>
				</div>
				<div class="col s5 offset-s1 card">
					<h6 id="sr0" style="font-weight:200;"></h6>
					<h6 id="sr1" style="font-weight:200;"></h6>
					<h6 id="sr2" style="font-weight:200;"></h6>
					<h6 id="sr3" style="font-weight:200;"></h6>
					<h6 id="sr4" style="font-weight:200;"></h6>
					<h6 id="sr5" style="font-weight:200;"></h6>
					
				</div>
				<div id='card2' class="col s12 card">
					<br><br><audio id="audio" controls></audio>
					<div class='card-image'>
						<img id=plot>
					</div>
				</div>
				<div id='card3' class="col s12 card">
					<br><br><audio id="audio2" controls></audio>
					<div class='card-image'>
						<img id=plot2>
					</div>
				</div>				

			</div>
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>	
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type=text/javascript>$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};</script>
	<script>window.jQuery || document.write('<script src="{{url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
	<script>
		record = false;
		$('.tooltipped').tooltip();
		$(function() {
			$('a#prediction').bind('click', function(event) {
			  $.getJSON($SCRIPT_ROOT + '/predict', {}, 
			  function(data) {
				if($("#alert").html()==0){
					$("#result").text(0);
					alertButton.click();
				}
				else {
					$("#result").text(data.result);
				}
				$("#plot").attr('src','static/plots/plt'+data.next+'.png');
				$("#plot2").attr('src','static/plots/plt'+data.next2+'.png');
			  });
			  document.getElementById('cards').style.display="block";
			  return false;
			});
		  });		  
		  
		var recordButton, word, alertButton, recorder, skipButton, playButton, audio, predictButton, mictooltip, cards, audio2, recognition;
		var recognizing = false;

		window.onload = function () {
		  recordButton = document.getElementById('record');
		  skipButton = document.getElementById('skip');
		  alertButton = document.getElementById('alert');		  
		  predictButton = document.getElementById('prediction');
		  audio = document.getElementById('audio');		  
		  audio2 = document.getElementById('audio2');		  
		  mictooltip = document.getElementById('mictooltip');		  
		  cards = document.getElementById('cards');
		  word = document.getElementById('word').innerHTML;
		  
		  // get audio stream from user's mic
		  navigator.mediaDevices.getUserMedia({
			audio: true
		  })
		  .then(function (stream) {
			recordButton.disabled = false;
			skipButton.disabled = false;
			recordButton.addEventListener('click', startRecording);
			
			recognition = new webkitSpeechRecognition();
			recognition.continuous = false;
			recognition.interimResults = false;
			recognition.maxAlternatives = 4;
			recognition.lang = "en-US";
			
			recognition.onstart = function() {
				recognizing = true;
			};	
			
			recognition.onspeechend = function() {
				recognizing = false;
				console.log("onspeechend");
				recognition.stop();
				recorder.stop();
			}
			
			recognition.onnomatch = function(event) {
				recognizing = false;
				console.log("nomatch");
				recognition.stop();
				recorder.stop();
			}
			
			recognition.onerror = function(event) {
				recognizing = false;
				console.log('Error occurred in recognition: ' + event.error);
				recognition.stop();
				recorder.stop();
			}
			
			recognition.onresult = function(e) {
				mictooltip.setAttribute("class", "btn-floating red tooltipped");
				recordButton.innerText = "mic";
				mictooltip.setAttribute("data-tooltip","speak!");
				// Stopping the recorder will eventually trigger the `dataavailable` event and we can complete the recording process
				var speechrecognition = false;
				console.log(e);
				for(var i=0; i<e.results[0].length; i++){
					var speech = e.results[0][i].transcript.split(" ")
					var confidence = e.results[0][i].confidence;
					document.getElementById('sr'+i).innerHTML= speech + " " + confidence;				
					if (word==speech) speechrecognition=true;
				}
				if(!speechrecognition) alertButton.innerHTML=0;
				else alertButton.innerHTML=1;
			};
			
			// listen to dataavailable, which gets triggered whenever we have
			// an audio blob available
			recorder = new MediaRecorder(stream, {'type': 'audio/mpeg;'});			
			recorder.addEventListener('dataavailable', onRecordingReady);
		  });
		};
		
		function startRecording() {
			if(!recognizing){
			  alertButton.innerHTML=1;
			  recorder.start();
			  recognition.start();
			  recordButton.innerText = "mic_off";
			  $("#mictooltip").attr("data-tooltip","stop!");
			  $("#mictooltip").tooltip("close");
			  $("#mictooltip").tooltip("open");
			  $("#mictooltip").attr("class", "btn-floating red tooltipped pulse");
			}
			else {
			  mictooltip.setAttribute("class", "btn-floating red tooltipped");
			  console.log("record off");
			  recordButton.innerText = "mic";
			  mictooltip.setAttribute("data-tooltip","speak!");
			  mictooltip.setAttribute("data-position","right");
			  recognition.stop();
			  recognizing = false;
			  recognition.stop();
			  recorder.stop();
			}
		}


		function onRecordingReady(e) {
		  mictooltip.setAttribute("class", "btn-floating red tooltipped");
		  recordButton.innerText = "mic";
		  mictooltip.setAttribute("data-tooltip","speak!");
		  // e.data contains a blob representing the recording
		  var url = URL.createObjectURL(e.data);
		  audio.src = url;
		  audio2.src = 'static/en/'+word+'/en-US-Standard-D.mp3';
		  var form = new FormData();
		  form.append('recording', e.data);
		  
		  $.ajax({
			  type: 'POST',
			  url: '/predict',
			  data: form,
			  cache: false,
			  processData: false,
			  contentType: false
			}).done(function(data) {predictButton.click();});
					
		}

	</script>
	</body>
</html>